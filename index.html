<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Lila Framework</title>

    <!--CSS-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.indigo.min.css">
    <!--CSS-->
    <script>

        const stores = new Map();
        const components = new Map();
        const currentInstances = new Set();

        function getComponents(name) {
            return components.get(name);
        }

        function reactive(obj) {
            const subscribers = new Set();

            return new Proxy(obj, {
                set(target, prop, value) {
                    if (target[prop] !== value) {
                        target[prop] = value;
                        subscribers.forEach(cb => cb(prop, value));
                    }
                    return true;
                },
                get(target, prop) {
                    if (prop === 'subscribe') {
                        return (callback) => {
                            subscribers.add(callback);
                            return () => subscribers.delete(callback);
                        };
                    }
                    return target[prop];
                }
            });
        }

        function createComponent(name, { template, state, actions, onMount, onDestroy }) {
            const templateFn = typeof template === 'string'
                ? compileTemplate(template)
                : template;
            components.set(name, {
                template: templateFn,
                state: state || (() => ({})),
                actions: actions || {},
                onMount,
                onDestroy
            });
        }

        function mountComponent(name, targetId, props = {}) {
            const target = document.getElementById(targetId);
            if (!target) {
                console.error(`Target element with id "${targetId}" not found`);
                return null;
            }

            const componentDef = components.get(name);
            if (!componentDef) {
                console.error(`Component "${name}" not found`);
                return null;
            }

            const state = reactive(componentDef.state(props));
            const boundElements = new Map();
            const nestedComponents = new Map();
            let isUpdating = false;

            function createUniqueId(el) {
                const id = 'nested-' + Math.random().toString(36).substr(2, 9);
                el.id = id;
                return id;
            }

            function update(onlyTheseProps = []) {
                if (isUpdating || !target) return;
                isUpdating = true;

                try {
                    if (onlyTheseProps.length === 0) {
                        const html = componentDef.template({ ...state, ...componentDef.actions });
                        if (typeof html === 'string') {
                            target.innerHTML = html;

                            target.querySelectorAll('[data-component]').forEach(el => {
                                const componentName = el.dataset.component;
                                const nestedComponent = mountComponent(componentName, el.id || createUniqueId(el));
                                if (nestedComponent) {
                                    nestedComponents.set(el, nestedComponent);
                                }
                            });


                            target.querySelectorAll('[data-action]').forEach(el => {
                                const actionName = el.dataset.action;
                                if (componentDef.actions[actionName] && !el._actionListener) {
                                    const listener = (e) => {
                                        if (e.target.tagName === 'FORM') {
                                            e.preventDefault();
                                        }
                                        componentDef.actions[actionName]({ state, event: e });
                                    };

                                    const eventType = el.tagName === 'FORM' ? 'submit' : 'click';
                                    el.addEventListener(eventType, listener);
                                    el._actionListener = listener;
                                }
                            });

                            target.querySelectorAll('[data-model]').forEach(input => {
                                const property = input.getAttribute('data-model');
                                if (input.value !== state[property]) {
                                    input.value = state[property];
                                }

                                if (!boundElements.has(input)) {
                                    const listener = (e) => {
                                        if (!isUpdating && state[property] !== e.target.value) {
                                            state[property] = e.target.value;
                                        }
                                    };
                                    input.addEventListener('input', listener);
                                    boundElements.set(input, { property, listener });
                                }
                            });
                        }
                    } else {
                        onlyTheseProps.forEach(prop => {
                            target.querySelectorAll(`[data-bind="${prop}"]`).forEach(el => {
                                el.textContent = state[prop];
                            });

                            target.querySelectorAll(`[data-model="${prop}"]`).forEach(input => {
                                if (input !== document.activeElement && input.value !== state[prop]) {
                                    input.value = state[prop];
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error during update:', error);
                } finally {
                    isUpdating = false;
                }
            }

            const unsubscribe = state.subscribe((prop) => {
                update([prop]);
            });

            update();

            if (componentDef.onMount) {
                setTimeout(() => {
                    try {
                        componentDef.onMount(state);
                    } catch (error) {
                        console.error('Error in onMount:', error);
                    }
                }, 0);
            }

            const componentInstance = {
                destroy: () => {
                    try {
                        if (componentDef.onDestroy) {
                            componentDef.onDestroy(state);
                        }
                    } catch (error) {
                        console.error('Error in onDestroy:', error);
                    }

                    nestedComponents.forEach(instance => {
                        try {
                            instance.destroy();
                        } catch (error) {
                            console.error('Error destroying nested component:', error);
                        }
                    });
                    nestedComponents.clear();

                    unsubscribe();
                    boundElements.forEach(({ listener }, input) => {
                        input?.removeEventListener('input', listener);
                    });
                    boundElements.clear();

                    if (target) {
                        target.querySelectorAll('[data-action]').forEach(el => {
                            if (el._actionListener) {
                                el.removeEventListener('click', el._actionListener);
                            }
                        });
                        target.innerHTML = '';
                    }
                },
                state
            };

            currentInstances.add(componentInstance);
            return componentInstance;
        }

        function handleRouting() {
            const path = window.location.hash.substring(1) || '/';
            const route = routes.get(path) || routes.get('*');

            if (!route) {
                console.error(`Route not found: ${path}`);
                return;
            }

            currentInstances.forEach(instance => {
                try {
                    instance.destroy();
                } catch (error) {
                    console.error('Error destroying instance:', error);
                }
            });
            currentInstances.clear();

            const outlet = document.getElementById('app-lila');
            if (outlet) {
                mountComponent(route.componentName, 'app-lila', route.props);
            } else {
                console.error('Router outlet not found');
            }
        }

        const routes = new Map();

        function addRoute(path, componentName, props = {}) {
            routes.set(path, { componentName, props });
        }

        function navigateTo(path) {
            window.location.hash = path;
        }
        function compileTemplate(templateId) {
            const templateElement = document.querySelector(`[data-template="${templateId}"]`);
            if (!templateElement) {
                console.error(`Template with ID "${templateId}" not found`);
                return () => '';
            }

            const html = templateElement.innerHTML;

            return (data) => {
                return html.replace(/\${([^}]+)}/g, (match, prop) => {
                    return data[prop.trim()] || '';
                });
            };
        }

        window.addEventListener('hashchange', handleRouting);
        document.addEventListener('click', e => {
            if (e.target.matches('[data-link]')) {
                e.preventDefault();
                navigateTo(e.target.getAttribute('href'));
            }
        });

        window.App = {
            reactive,
            createComponent,
            addRoute,
            navigateTo,
            mountComponent,
            getComponents
        };


    </script>
</head>

<body>
    <header class="container">
        <nav>
            <a href="/" data-link>Inicio</a>
            <a href="/about" data-link>Acerca de</a>
            <a href="/counter" data-link>Contador</a>
        </nav>
    </header>

    <main id="app-lila" class="container"></main>

    <footer>

    </footer>

    <template data-template="home-template">
        <h1>¡Bienvenido a la página de inicio!</h1>

        <form data-action="submit">
            <input type="text" name="greet" data-bind="greet" placeholder="Ingresa tu saludo" class="w-full" />
            <button type="submit" class="contrast">
                <i class="icon-send"></i>Enviar
            </button>
            <br />
        </form>
        <br />
        <div>
            <p>Tu saludo es: <span data-bind="greet"></span></p>
        </div>
        <div class="input-icon">
            <i class="icon-edit"></i>
            <input type="text" data-model="greet" placeholder="Cambiar saludo" value="">
        </div>
        <button data-action="changeGreeting" class="w-full">
            <i class="icon-check-circle"></i>Cambiar Saludo
        </button>
        <br />
        <div data-component="Counter"></div>
    </template>

    <template data-template="about-template">
        <h1>Acerca de</h1>
        <p>Esta es la página acerca de nosotros.</p>
        
    </template>

    <template data-template="counter-template">
        <h1>Contador</h1>
        <p>Conteo actual: <span data-bind="count"></span></p>
        <div class="flex between gap-2">
            <button data-action="increment" class="secondary">Incrementar</button>
            <button data-action="decrement" class="secondary">Disminuir</button>
            <button data-action="reset" class="secondary">Reiniciar</button>
        </div>
    </template>

    <template data-template="not-found-template">
        <h1>404 No Encontrado</h1>
        <p>La página que buscas no existe.</p>
        <button data-action="goHome">Ir al Inicio</button>
    </template>



    <script>
         
        App.createComponent('Home', {
            template: 'home-template',
            state: () => ({
                greet: null
            }),
            actions: {
                changeGreeting: ({ state }) => {
                    state.greet = state.greet === "Hello World!"
                        ? "Hola Mundo!"
                        : "Hello World!";
                    console.log(state.greet);
                },
                submit: ({ state, event }) => {
                    event.preventDefault();
                    const formData = Object.fromEntries(new FormData(event.target));
                    console.log('Form submitted:', formData);
                    alert(JSON.stringify(formData));
                }
            }
        });

        App.createComponent('About', {
            template: 'about-template'
        });

        const incrementCounter=({ state }) => { state.count++ };
        
        App.createComponent('Counter', {
            template: 'counter-template',
            state: () => ({
                count: 0,
                interval: null
            }),
            actions: {
                increment: incrementCounter,
                decrement: ({ state }) => { state.count-- },
                reset: ({ state }) => { state.count = 0 }
            },
            onMount: (state) => {
                console.log('Counter mounted');
                state.interval = setInterval(() => {
                    console.log('Interval tick', state.count);
                    state.count++;
                }, 1000);
            },
            onDestroy: (state) => {
                console.log('Counter destroyed');
                if (state.interval) {
                    clearInterval(state.interval);
                    state.interval = null;
                }
            }
        });

        App.createComponent('NotFound', {
            template: 'not-found-template',
            actions: {
                goHome: () => {
                    App.navigateTo('#/');
                }
            }
        });

        App.addRoute('/', 'Home');
        App.addRoute('/about', 'About');
        App.addRoute('/counter', 'Counter');
        App.addRoute('*', 'NotFound');

        handleRouting();
    </script>


</body>

</html>